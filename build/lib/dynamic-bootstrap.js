// Generate a bootstrap for the UIAuto Instruments script containing
// the environment variables we need.

'use strict';

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _crypto = require('crypto');

var _crypto2 = _interopRequireDefault(_crypto);

var _mkdirp2 = require('mkdirp');

var _mkdirp3 = _interopRequireDefault(_mkdirp2);

var _fs2 = require('fs');

var _fs3 = _interopRequireDefault(_fs2);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _buildCode = require('./build-code');

var _buildCode2 = _interopRequireDefault(_buildCode);

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var mkdirp = _bluebird2['default'].promisify(_mkdirp3['default']);
var fs = {
  readFile: _bluebird2['default'].promisify(_fs3['default'].readFile),
  writeFile: _bluebird2['default'].promisify(_fs3['default'].writeFile)
};

function getEnv(opts) {
  opts = opts || {};
  var bootstrapEnv = {
    nodePath: process.execPath,
    commandProxyClientPath: _path2['default'].resolve(__dirname, './bin/command-proxy-client.js'),
    instrumentsSock: opts.sock || '/tmp/instruments_sock',
    interKeyDelay: opts.interKeyDelay || null,
    justLoopInfinitely: opts.justLoopInfinitely,
    autoAcceptAlerts: opts.autoAcceptAlerts,
    autoDismissAlerts: opts.autoDismissAlerts,
    sendKeyStrategy: opts.sendKeyStrategy
  };
  return bootstrapEnv;
}

function buildCode(opts) {
  var env, bootstrapJs, imports, bootstrapCode, lines, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, _step$value, key, value, quote;

  return _regeneratorRuntime.async(function buildCode$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!opts.code) {
          context$1$0.next = 2;
          break;
        }

        return context$1$0.abrupt('return', opts.code);

      case 2:
        env = getEnv(opts);

        _logger2['default'].debug('Dynamic env: ' + JSON.stringify(env));

        bootstrapJs = _path2['default'].resolve(__dirname, '../../uiauto/bootstrap.js');
        imports = opts.imports && opts.imports.pre ? opts.imports.pre : [];
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap((0, _buildCode2['default'])(bootstrapJs, imports));

      case 8:
        bootstrapCode = context$1$0.sent;
        lines = [];

        lines.push('// This file is automatically generated. Do not manually modify!');
        lines.push('');
        lines.push(bootstrapCode);
        lines.push('');
        lines.push('bootstrap({');
        _iteratorNormalCompletion = true;
        _didIteratorError = false;
        _iteratorError = undefined;
        context$1$0.prev = 18;
        for (_iterator = _getIterator(_lodash2['default'].pairs(env)); !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
          _step$value = _slicedToArray(_step.value, 2);
          key = _step$value[0];
          value = _step$value[1];

          if (!_lodash2['default'].isUndefined(value)) {
            quote = _lodash2['default'].isString(value) ? '"' : '';

            lines.push('  "' + key + '": ' + quote + value + quote + ',');
          }
        }
        context$1$0.next = 26;
        break;

      case 22:
        context$1$0.prev = 22;
        context$1$0.t0 = context$1$0['catch'](18);
        _didIteratorError = true;
        _iteratorError = context$1$0.t0;

      case 26:
        context$1$0.prev = 26;
        context$1$0.prev = 27;

        if (!_iteratorNormalCompletion && _iterator['return']) {
          _iterator['return']();
        }

      case 29:
        context$1$0.prev = 29;

        if (!_didIteratorError) {
          context$1$0.next = 32;
          break;
        }

        throw _iteratorError;

      case 32:
        return context$1$0.finish(29);

      case 33:
        return context$1$0.finish(26);

      case 34:
        lines[lines.length - 1] = lines[lines.length - 1].replace(/,$/, '');
        lines.push('});');
        return context$1$0.abrupt('return', lines.join('\r\n'));

      case 37:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[18, 22, 26, 34], [27,, 29, 33]]);
}

function computeHash(code) {
  return _crypto2['default'].createHash('md5').update(code).digest('hex').substring(0, 16);
}

function getDynamicBootstrapDir() {
  var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

  // figuring out where to store dynamic bootstrap
  var dynamicBootstrapDir = undefined;
  if (process.env.APPIUM_BOOTSTRAP_DIR) {
    // mainly for test
    dynamicBootstrapDir = process.env.APPIUM_BOOTSTRAP_DIR;
  } else if (process.env.HOME) {
    dynamicBootstrapDir = _path2['default'].resolve(process.env.HOME, 'Library/Application Support/appium/bootstrap');
  } else {
    // no user dir, using tmp
    dynamicBootstrapDir = _path2['default'].resolve(opts.tmpDir || '/tmp', 'appium/bootstrap');
  }
  return dynamicBootstrapDir;
}

function writeDynamicBootstrapIfNecessary(dynamicBootstrapDir, dynamicBootstrapPath, code, hash) {
  var codeIsGood, existingCode;
  return _regeneratorRuntime.async(function writeDynamicBootstrapIfNecessary$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(mkdirp(dynamicBootstrapDir));

      case 2:
        codeIsGood = true;
        context$1$0.prev = 3;
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(fs.readFile(dynamicBootstrapPath));

      case 6:
        existingCode = context$1$0.sent;

        codeIsGood = computeHash(existingCode) === hash;
        context$1$0.next = 13;
        break;

      case 10:
        context$1$0.prev = 10;
        context$1$0.t0 = context$1$0['catch'](3);

        codeIsGood = false;

      case 13:
        if (!codeIsGood) {
          context$1$0.next = 17;
          break;
        }

        _logger2['default'].debug('Reusing dynamic bootstrap: ' + dynamicBootstrapPath);
        context$1$0.next = 20;
        break;

      case 17:
        _logger2['default'].debug('Creating or overwriting dynamic bootstrap: ' + dynamicBootstrapPath);
        context$1$0.next = 20;
        return _regeneratorRuntime.awrap(fs.writeFile(dynamicBootstrapPath, code, { flag: 'w+' }));

      case 20:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[3, 10]]);
}

function prepareBootstrap() {
  var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];
  var dynamicBootstrapDir, code, hash, dynamicBootstrapPath;
  return _regeneratorRuntime.async(function prepareBootstrap$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Preparing bootstrap code');

        dynamicBootstrapDir = getDynamicBootstrapDir(opts);

        _logger2['default'].debug('Dynamic bootstrap dir: ' + dynamicBootstrapDir);

        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(buildCode(opts));

      case 5:
        code = context$1$0.sent;
        hash = computeHash(code);
        dynamicBootstrapPath = _path2['default'].resolve(dynamicBootstrapDir, 'bootstrap-' + hash + '.js');

        _logger2['default'].debug('Dynamic bootstrap code: ' + code.split('\n')[0] + '...');
        _logger2['default'].debug('Dynamic bootstrap path: ' + dynamicBootstrapPath);

        context$1$0.next = 12;
        return _regeneratorRuntime.awrap(writeDynamicBootstrapIfNecessary(dynamicBootstrapDir, dynamicBootstrapPath, code, hash));

      case 12:
        return context$1$0.abrupt('return', dynamicBootstrapPath);

      case 13:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

exports.prepareBootstrap = prepareBootstrap;
exports.getEnv = getEnv;

// generate the dynamic part of the bootstrap code

// check existing code

// write file if necessary
// building code and hash
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9keW5hbWljLWJvb3RzdHJhcC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7OztvQkFHaUIsTUFBTTs7OztzQkFDVCxRQUFROzs7O3NCQUNILFFBQVE7Ozs7dUJBQ1AsUUFBUTs7OzttQkFDWixJQUFJOzs7O3dCQUNBLFVBQVU7Ozs7eUJBQ04sY0FBYzs7OztzQkFDdEIsVUFBVTs7OztBQUUxQixJQUFJLE1BQU0sR0FBRyxzQkFBUSxTQUFTLHFCQUFTLENBQUM7QUFDeEMsSUFBSSxFQUFFLEdBQUc7QUFDUCxVQUFRLEVBQUUsc0JBQVEsU0FBUyxDQUFDLGdCQUFJLFFBQVEsQ0FBQztBQUN6QyxXQUFTLEVBQUUsc0JBQVEsU0FBUyxDQUFDLGdCQUFJLFNBQVMsQ0FBQztDQUM1QyxDQUFDOztBQUdGLFNBQVMsTUFBTSxDQUFFLElBQUksRUFBRTtBQUNyQixNQUFJLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztBQUNsQixNQUFJLFlBQVksR0FBRztBQUNqQixZQUFRLEVBQUUsT0FBTyxDQUFDLFFBQVE7QUFDMUIsMEJBQXNCLEVBQUUsa0JBQUssT0FBTyxDQUNsQyxTQUFTLEVBQUUsK0JBQStCLENBQUM7QUFDN0MsbUJBQWUsRUFBRSxJQUFJLENBQUMsSUFBSSxJQUFJLHVCQUF1QjtBQUNyRCxpQkFBYSxFQUFFLElBQUksQ0FBQyxhQUFhLElBQUksSUFBSTtBQUN6QyxzQkFBa0IsRUFBRSxJQUFJLENBQUMsa0JBQWtCO0FBQzNDLG9CQUFnQixFQUFFLElBQUksQ0FBQyxnQkFBZ0I7QUFDdkMscUJBQWlCLEVBQUUsSUFBSSxDQUFDLGlCQUFpQjtBQUN6QyxtQkFBZSxFQUFFLElBQUksQ0FBQyxlQUFlO0dBQ3RDLENBQUM7QUFDRixTQUFPLFlBQVksQ0FBQztDQUNyQjs7QUFFRCxTQUFlLFNBQVMsQ0FBRSxJQUFJO01BR3hCLEdBQUcsRUFHSCxXQUFXLEVBQ1gsT0FBTyxFQUNQLGFBQWEsRUFHYixLQUFLLCtGQU1DLEdBQUcs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SUFBSSxFQUFFLElBQUksQ0FBQzs7OzRDQUU1QixvQkFBb0I7Ozs7Ozs7Q0FDNUI7O1FBRVEsZ0JBQWdCLEdBQWhCLGdCQUFnQjtRQUFFLE1BQU0sR0FBTixNQUFNIiwiZmlsZSI6ImxpYi9keW5hbWljLWJvb3RzdHJhcC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIEdlbmVyYXRlIGEgYm9vdHN0cmFwIGZvciB0aGUgVUlBdXRvIEluc3RydW1lbnRzIHNjcmlwdCBjb250YWluaW5nXG4vLyB0aGUgZW52aXJvbm1lbnQgdmFyaWFibGVzIHdlIG5lZWQuXG5cbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBjcnlwdG8gZnJvbSAnY3J5cHRvJztcbmltcG9ydCBfbWtkaXJwIGZyb20gJ21rZGlycCc7XG5pbXBvcnQgX2ZzIGZyb20gJ2ZzJztcbmltcG9ydCBQcm9taXNlIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCBidWlsZFNjcmlwdCBmcm9tICcuL2J1aWxkLWNvZGUnO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5cbmxldCBta2RpcnAgPSBQcm9taXNlLnByb21pc2lmeShfbWtkaXJwKTtcbmxldCBmcyA9IHtcbiAgcmVhZEZpbGU6IFByb21pc2UucHJvbWlzaWZ5KF9mcy5yZWFkRmlsZSksXG4gIHdyaXRlRmlsZTogUHJvbWlzZS5wcm9taXNpZnkoX2ZzLndyaXRlRmlsZSlcbn07XG5cblxuZnVuY3Rpb24gZ2V0RW52IChvcHRzKSB7XG4gIG9wdHMgPSBvcHRzIHx8IHt9O1xuICBsZXQgYm9vdHN0cmFwRW52ID0ge1xuICAgIG5vZGVQYXRoOiBwcm9jZXNzLmV4ZWNQYXRoLFxuICAgIGNvbW1hbmRQcm94eUNsaWVudFBhdGg6IHBhdGgucmVzb2x2ZShcbiAgICAgIF9fZGlybmFtZSwgJy4vYmluL2NvbW1hbmQtcHJveHktY2xpZW50LmpzJyksXG4gICAgaW5zdHJ1bWVudHNTb2NrOiBvcHRzLnNvY2sgfHwgJy90bXAvaW5zdHJ1bWVudHNfc29jaycsXG4gICAgaW50ZXJLZXlEZWxheTogb3B0cy5pbnRlcktleURlbGF5IHx8IG51bGwsXG4gICAganVzdExvb3BJbmZpbml0ZWx5OiBvcHRzLmp1c3RMb29wSW5maW5pdGVseSxcbiAgICBhdXRvQWNjZXB0QWxlcnRzOiBvcHRzLmF1dG9BY2NlcHRBbGVydHMsXG4gICAgYXV0b0Rpc21pc3NBbGVydHM6IG9wdHMuYXV0b0Rpc21pc3NBbGVydHMsXG4gICAgc2VuZEtleVN0cmF0ZWd5OiBvcHRzLnNlbmRLZXlTdHJhdGVneSxcbiAgfTtcbiAgcmV0dXJuIGJvb3RzdHJhcEVudjtcbn1cblxuYXN5bmMgZnVuY3Rpb24gYnVpbGRDb2RlIChvcHRzKSB7XG4gIGlmIChvcHRzLmNvZGUpIHJldHVybiBvcHRzLmNvZGU7XG5cbiAgbGV0IGVudiA9IGdldEVudihvcHRzKTtcbiAgbG9nLmRlYnVnKGBEeW5hbWljIGVudjogJHtKU09OLnN0cmluZ2lmeShlbnYpfWApO1xuXG4gIGxldCBib290c3RyYXBKcyA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLi8uLi91aWF1dG8vYm9vdHN0cmFwLmpzJyk7XG4gIGxldCBpbXBvcnRzID0gKG9wdHMuaW1wb3J0cyAmJiBvcHRzLmltcG9ydHMucHJlKSA/IG9wdHMuaW1wb3J0cy5wcmUgOiBbXTtcbiAgbGV0IGJvb3RzdHJhcENvZGUgPSBhd2FpdCBidWlsZFNjcmlwdChib290c3RyYXBKcywgaW1wb3J0cyk7XG5cbiAgLy8gZ2VuZXJhdGUgdGhlIGR5bmFtaWMgcGFydCBvZiB0aGUgYm9vdHN0cmFwIGNvZGVcbiAgbGV0IGxpbmVzID0gW107XG4gIGxpbmVzLnB1c2goJy8vIFRoaXMgZmlsZSBpcyBhdXRvbWF0aWNhbGx5IGdlbmVyYXRlZC4gRG8gbm90IG1hbnVhbGx5IG1vZGlmeSEnKTtcbiAgbGluZXMucHVzaCgnJyk7XG4gIGxpbmVzLnB1c2goYm9vdHN0cmFwQ29kZSk7XG4gIGxpbmVzLnB1c2goJycpO1xuICBsaW5lcy5wdXNoKCdib290c3RyYXAoeycpO1xuICBmb3IgKGxldCBba2V5LCB2YWx1ZV0gb2YgXy5wYWlycyhlbnYpKSB7XG4gICAgaWYgKCFfLmlzVW5kZWZpbmVkKHZhbHVlKSkge1xuICAgICAgbGV0IHF1b3RlID0gXy5pc1N0cmluZyh2YWx1ZSkgPyAnXFxcIicgOiAnJztcbiAgICAgIGxpbmVzLnB1c2goYCAgXCIke2tleX1cIjogJHtxdW90ZX0ke3ZhbHVlfSR7cXVvdGV9LGApO1xuICAgIH1cbiAgfVxuICBsaW5lc1tsaW5lcy5sZW5ndGggLSAxXSA9IGxpbmVzW2xpbmVzLmxlbmd0aCAtIDFdLnJlcGxhY2UoLywkLywgJycpO1xuICBsaW5lcy5wdXNoKCd9KTsnKTtcbiAgcmV0dXJuIGxpbmVzLmpvaW4oJ1xcclxcbicpO1xufVxuXG5mdW5jdGlvbiBjb21wdXRlSGFzaCAoY29kZSkge1xuICByZXR1cm4gY3J5cHRvXG4gICAgLmNyZWF0ZUhhc2goJ21kNScpXG4gICAgLnVwZGF0ZShjb2RlKVxuICAgIC5kaWdlc3QoJ2hleCcpXG4gICAgLnN1YnN0cmluZygwLCAxNik7XG59XG5cbmZ1bmN0aW9uIGdldER5bmFtaWNCb290c3RyYXBEaXIgKG9wdHMgPSB7fSkge1xuICAvLyBmaWd1cmluZyBvdXQgd2hlcmUgdG8gc3RvcmUgZHluYW1pYyBib290c3RyYXBcbiAgbGV0IGR5bmFtaWNCb290c3RyYXBEaXI7XG4gIGlmIChwcm9jZXNzLmVudi5BUFBJVU1fQk9PVFNUUkFQX0RJUikge1xuICAgIC8vIG1haW5seSBmb3IgdGVzdFxuICAgIGR5bmFtaWNCb290c3RyYXBEaXIgPSBwcm9jZXNzLmVudi5BUFBJVU1fQk9PVFNUUkFQX0RJUjtcbiAgfSBlbHNlIGlmIChwcm9jZXNzLmVudi5IT01FKSB7XG4gICAgZHluYW1pY0Jvb3RzdHJhcERpciA9IHBhdGgucmVzb2x2ZShwcm9jZXNzLmVudi5IT01FLFxuICAgICAgJ0xpYnJhcnkvQXBwbGljYXRpb24gU3VwcG9ydC9hcHBpdW0vYm9vdHN0cmFwJyk7XG4gIH0gZWxzZSB7XG4gICAgLy8gbm8gdXNlciBkaXIsIHVzaW5nIHRtcFxuICAgIGR5bmFtaWNCb290c3RyYXBEaXIgPSBwYXRoLnJlc29sdmUob3B0cy50bXBEaXIgfHwgJy90bXAnLCAnYXBwaXVtL2Jvb3RzdHJhcCcpO1xuICB9XG4gIHJldHVybiBkeW5hbWljQm9vdHN0cmFwRGlyO1xufVxuXG5hc3luYyBmdW5jdGlvbiB3cml0ZUR5bmFtaWNCb290c3RyYXBJZk5lY2Vzc2FyeSAoZHluYW1pY0Jvb3RzdHJhcERpciwgZHluYW1pY0Jvb3RzdHJhcFBhdGgsIGNvZGUsIGhhc2gpIHtcbiAgYXdhaXQgbWtkaXJwKGR5bmFtaWNCb290c3RyYXBEaXIpO1xuICAvLyBjaGVjayBleGlzdGluZyBjb2RlXG4gIGxldCBjb2RlSXNHb29kID0gdHJ1ZTtcbiAgdHJ5IHtcbiAgICBsZXQgZXhpc3RpbmdDb2RlID0gYXdhaXQgZnMucmVhZEZpbGUoZHluYW1pY0Jvb3RzdHJhcFBhdGgpO1xuICAgIGNvZGVJc0dvb2QgPSBjb21wdXRlSGFzaChleGlzdGluZ0NvZGUpID09PSBoYXNoO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBjb2RlSXNHb29kID0gZmFsc2U7XG4gIH1cbiAgLy8gd3JpdGUgZmlsZSBpZiBuZWNlc3NhcnlcbiAgaWYgKGNvZGVJc0dvb2QpIHtcbiAgICBsb2cuZGVidWcoYFJldXNpbmcgZHluYW1pYyBib290c3RyYXA6ICR7ZHluYW1pY0Jvb3RzdHJhcFBhdGh9YCk7XG4gIH0gZWxzZSB7XG4gICAgbG9nLmRlYnVnKGBDcmVhdGluZyBvciBvdmVyd3JpdGluZyBkeW5hbWljIGJvb3RzdHJhcDogJHtkeW5hbWljQm9vdHN0cmFwUGF0aH1gKTtcbiAgICBhd2FpdCBmcy53cml0ZUZpbGUoZHluYW1pY0Jvb3RzdHJhcFBhdGgsIGNvZGUsIHtmbGFnOiAndysnfSk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gcHJlcGFyZUJvb3RzdHJhcCAob3B0cyA9IHt9KSB7XG4gIGxvZy5kZWJ1ZygnUHJlcGFyaW5nIGJvb3RzdHJhcCBjb2RlJyk7XG5cbiAgbGV0IGR5bmFtaWNCb290c3RyYXBEaXIgPSBnZXREeW5hbWljQm9vdHN0cmFwRGlyKG9wdHMpO1xuICBsb2cuZGVidWcoYER5bmFtaWMgYm9vdHN0cmFwIGRpcjogJHtkeW5hbWljQm9vdHN0cmFwRGlyfWApO1xuXG4gIC8vIGJ1aWxkaW5nIGNvZGUgYW5kIGhhc2hcbiAgbGV0IGNvZGUgPSBhd2FpdCBidWlsZENvZGUob3B0cyk7XG4gIGxldCBoYXNoID0gY29tcHV0ZUhhc2goY29kZSk7XG4gIGxldCBkeW5hbWljQm9vdHN0cmFwUGF0aCA9IHBhdGgucmVzb2x2ZShkeW5hbWljQm9vdHN0cmFwRGlyLFxuICAgIGBib290c3RyYXAtJHtoYXNofS5qc2ApO1xuICBsb2cuZGVidWcoYER5bmFtaWMgYm9vdHN0cmFwIGNvZGU6ICR7Y29kZS5zcGxpdCgnXFxuJylbMF19Li4uYCk7XG4gIGxvZy5kZWJ1ZyhgRHluYW1pYyBib290c3RyYXAgcGF0aDogJHtkeW5hbWljQm9vdHN0cmFwUGF0aH1gKTtcblxuICBhd2FpdCB3cml0ZUR5bmFtaWNCb290c3RyYXBJZk5lY2Vzc2FyeShkeW5hbWljQm9vdHN0cmFwRGlyLFxuICAgIGR5bmFtaWNCb290c3RyYXBQYXRoLCBjb2RlLCBoYXNoKTtcblxuICByZXR1cm4gZHluYW1pY0Jvb3RzdHJhcFBhdGg7XG59XG5cbmV4cG9ydCB7IHByZXBhcmVCb290c3RyYXAsIGdldEVudiB9OyJdfQ==